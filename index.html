<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Diggin' time! (BETA)</title>
    <meta
      name="description"
      content="A realistic op-shop record hunting simulator (of sorts). Prepare to be disappointed!"
    />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Bagel+Fat+One&family=Inter:ital,opsz,wght@0,14..32,100..900;1,14..32,100..900&display=swap"
      rel="stylesheet"
    />
    <link rel="shortcut icon" href="./favicon.png" />

    <style>
      :root {
        --bg-color: #e1dfd1;
        --text-color: #333;
        --text-color--modal: var(--text-color);
        --text-color--button: var(--text-color);

        --shelf-color: #f0eae1;
        --wall-color: #ffffff20;

        --highlight-color-good: var(--text-color);
        --highlight-color-bad: var(--text-color);

        --title-color: #ffdf8f;

        --bodyFont: "Inter", sans-serif;
        --titleFont: "Bagel Fat One", "Inter", sans-serif;

        --crate-size: 145px;
        @media (width> 500px) {
          --crate-size: 200px;
        }
        @media (width> 1000px) {
          --crate-size: 220px;
        }
        @media (height> 1000px) {
          --crate-size: 250px;
        }
        @media (height> 1200px) {
          --crate-size: 300px;
        }
      }
      html * {
        box-sizing: border-box;
        position: relative;
      }
      body {
        background-color: var(--bg-color);
        color: var(--text-color);
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        margin: 0;
        padding: 20px 10px 50px;
        box-sizing: border-box;
        user-select: none;
        -webkit-user-select: none;
        touch-action: none;
        font-family: var(--bodyFont);
        font-size: 14px;
        min-height: 100vh;
        @media (width>500px) {
          font-size: 16px;
        }
        @media (width> 1000px) {
          font-size: 18px;
        }
        @media (width> 1200px) {
          font-size: 20px;
        }
      }

      .loading {
        opacity: 0;
      }

      main {
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        transition: opacity 0.5s ease;
      }

      #background-image {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        transition: opacity 0.5s ease;
      }

      #background-image img {
        position: absolute;
        width: 100%;
        height: 100%;
        object-fit: cover;
      }

      .score-board {
        position: sticky;
        z-index: 100;
        top: 20px;
        display: flex;
        gap: 10px;
        justify-content: space-between;
        align-items: center;
        width: 100%;
        font-size: 0.8em;
        text-align: center;
      }
      .score-board--inner {
        display: flex;
        gap: 2px;
        border-radius: 5px;
        overflow: hidden;
      }

      .score-board--inner > span {
        background-color: #ffffff60;
        backdrop-filter: blur(20px);
        padding: 0.5em 0.75em;
        font-weight: 600;
      }

      .game-container {
        display: flex;
        gap: 10px;
        background-color: var(--wall-color);
        border-radius: 20px;
        flex-direction: column;
        align-items: center;
        padding: 10px 10px 40px;
        gap: 0;
        box-shadow: 0 0 60px #00000020;
        backdrop-filter: blur(10px);
        @media (width>500px) {
          padding: 20px 20px 40px;
        }
      }

      h1,
      h2,
      h3 {
        font-family: var(--titleFont);
        line-height: 0.73;
        letter-spacing: -0.02em;
        margin: 0 auto 0.45em;
        text-shadow: 0 4px 4px #00000010, 0 10px 20px #00000020,
          0 20px 50px #00000030;
        color: var(--title-color);
        transform: rotate(-3deg);
      }

      h1 {
        text-align: center;
        font-size: 5.5em;
      }

      h1 span {
        display: inline-flex;
        font-family: var(--bodyFont);
        font-size: 13px;
        letter-spacing: normal;
        position: absolute;
        bottom: -1.3em;
        left: 70%;
        transform: translateX(-50%) rotate(2deg);
        z-index: 1;
        line-height: 1;
        color: var(--text-color);
        text-shadow: none;
        background-color: white;
        padding: 0.35em 0.75em;
        border-radius: 5em;
        border: 1px solid #00000030;
        box-shadow: 0 2px 15px #00000030;
        text-transform: uppercase;
      }

      h2 {
        font-size: 4.5em;
        max-width: 7ch;
      }

      p {
        line-height: 1.5;
      }

      .btn {
        font-size: 1em;
        padding: 0.5em 1em;
        background: #ffffffcc;
        backdrop-filter: blur(20px);
        color: var(--text-color--button);
        font-weight: 600;
        border: none;
        border-radius: 5em;
        cursor: pointer;
        transition: background-color 0.25s, transform 0.25s;
        box-shadow: 0 2px 10px #00000020, 0 10px 20px #00000010,
          0 5px 10px #00000010, inset 0 2px 3px #ffffff90;
      }

      .btn:hover,
      .btn:focus-visible {
        background-color: white;
        transform: scale(1.05);
      }

      #loader {
        position: absolute;
        top: 50%;
        left: 50%;
        display: inline-flex;
        pointer-events: none;
        opacity: 0;
        transition: opacity 0.5s ease, transform 0.5s ease;
        transform: translate(-50%, -50%) scale(0.2);
      }

      .isLoading #loader {
        opacity: 1;
        transform: translate(-50%, -50%);
        z-index: 1001;
        padding: 1em;
        background: #ffffff50;
        border-radius: 10em;
        margin-inline: auto;
        font-size: 1.2em;
        font-weight: 600;
        padding: 0.5em 1em;
      }

      .isLoading .modal {
        display: none !important;
      }

      .isLoading main,
      .isLoading #background-image,
      .isLoading footer {
        opacity: 0;
      }

      .crates-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 0 10px;
        touch-action: none;
        overflow: hidden;
        padding-inline: 15px;
        padding-bottom: 2px;
        @media (width>500px) {
          padding-inline: 25px;
        }
      }

      .crate-container {
        position: relative;
        width: var(--crate-size);
        height: calc(var(--crate-size) * 1.7);
        margin-bottom: 10px;
      }

      .crate-container:after {
        pointer-events: none;
        content: "";
        position: absolute;
        top: 100%;
        left: -5px;
        right: -5px;
        height: 10px;
        background-color: var(--shelf-color);
        border-top: 1px solid #ffffff90;
        border-bottom: 1px solid #00000060;
        box-shadow: 0 5px 5px #00000010;
        z-index: 10;
      }
      .crate-container:before {
        pointer-events: none;
        content: "";
        position: absolute;
        top: 50%;
        left: -5px;
        right: -5px;
        height: 80%;
        z-index: 10;
        background: linear-gradient(
          180deg,
          rgba(0, 0, 0, 0) 0%,
          rgba(0, 0, 0, 0.2) 63%,
          rgba(0, 0, 0, 0.1) 64%,
          rgba(0, 0, 0, 0) 100%
        );
      }

      .crate-container:nth-of-type(odd):after {
        left: -23px;
      }
      .crate-container:nth-of-type(odd):before {
        left: -20px;
      }
      .crate-container:nth-of-type(odd):after {
        border-radius: 3px 0 0 3px;
      }
      .crate-container:nth-of-type(odd) .record.pop {
        transform: translateY(5%) rotate(1deg);
      }

      .crate-container:nth-of-type(even):after {
        right: -23px;
      }
      .crate-container:nth-of-type(even):before {
        right: -20px;
      }
      .crate-container:nth-of-type(even):after {
        border-radius: 0 3px 3px 0;
      }
      .crate-container:nth-of-type(even) .record.pop {
        transform: translateY(5%) rotate(-1deg);
      }

      .crate-container:nth-of-type(2) .crate-box {
        background-image: url(./assets/crate-plastic--blue.webp);
      }
      /* TAPE */
      .crate-container:nth-of-type(2) .crate-box:before {
        content: "";
        z-index: 2;
        width: 9px;
        height: 18px;
        background-color: #f0efe380;
        position: absolute;
        left: 50%;
        transform: translateX(-50%) rotate(-2deg);
        top: 33%;
        box-shadow: 0 1px 2px #00000030;
      }
      /* SIGN */
      .crate-container:nth-of-type(2) .crate-box:after {
        content: "records: $2 each";
        color: #000000aa;
        position: absolute;
        background-color: #e6dda6dd;
        background: linear-gradient(349deg, #f0efe3 0%, #e6dda6dd 100%);
        box-shadow: 2px 3px 2px #00000060;
        padding: 1em;
        font-weight: 600;
        left: 50%;
        transform: translateX(-50%) rotate(-4deg);
        top: 37%;
        border-radius: 3px;
        font-size: 0.8em;
        text-align: center;
        z-index: 1;
      }

      .crate-container:nth-of-type(3) .crate-box {
        background-image: url(./assets/crate-plastic--green.webp);
      }
      .crate-container:nth-of-type(4) .crate-box {
        background-image: url(./assets/crate-plastic--red.webp);
      }

      .crate-box {
        position: absolute;
        width: 100%;
        aspect-ratio: 1;
        background: url(./assets/crate-plastic.webp) no-repeat bottom left;
        background-size: 100% 85%;
        bottom: 0;
        left: 0;
        z-index: 10;
        pointer-events: none;
      }

      .record {
        will-change: transform;
        border: none;
        background-color: transparent;
        padding: 0;
        border-radius: 3px;
        overflow: hidden;
        position: absolute;
        top: 4%;
        left: 4%;
        width: 92%;
        aspect-ratio: 1;
        cursor: pointer;
        transition: transform 0.15s cubic-bezier(0.71, -0.36, 0.35, 1.37);
        transform: translateY(76%);
        z-index: 1;
        -webkit-tap-highlight-color: transparent;
      }
      .record:after {
        content: "";
        position: absolute;
        pointer-events: none;
        bottom: 0;
        left: 0;
        right: 0;
        height: 55%;
        background: linear-gradient(
          180deg,
          rgba(0, 0, 0, 0) 0%,
          rgba(0, 0, 0, 0.5) 40%,
          rgba(0, 0, 0, 0.5) 100%
        );
      }
      .record:active {
        opacity: 0.9;
      }

      /* @media screen and (pointer: fine) {
        .bad-record:active {
          animation: badRecordPress 0.15s ease forwards;
        }

        .good-record:active {
          animation: goodRecordPress 0.15s ease forwards;
        }
      }

      @keyframes badRecordPress {
        0% {
          outline: 0 solid var(--highlight-color-bad);
        }
        100% {
          outline: 10px solid transparent;
          outline-offset: 5px;
        }
      }
      @keyframes goodRecordPress {
        0% {
          outline: 0 solid var(--highlight-color-good);
        }
        100% {
          outline: 15px solid transparent;
          outline-offset: 5px;
        }
      } */
      .record.pop {
        pointer-events: auto;
        transform: translateY(0);
        transition: transform 0.25s cubic-bezier(0.71, -0.36, 0.35, 1.37);
      }
      .record-img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }
      .crate-cover {
        position: absolute;
        bottom: 0;
        left: 3%;
        width: 94%;
        aspect-ratio: 1;
        z-index: 5;
        transform: translateY(0);
        border-radius: 2px;
        background-color: black;
        pointer-events: none;
      }

      .crate-cover img {
        opacity: 0.85;
      }

      .crate-cover:before {
        content: "";
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        top: 20%;
        z-index: 1;
        background-color: #00000070;
      }

      .modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: #e1dfd190;
        color: var(--text-color--modal);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 1000;
        backdrop-filter: blur(20px);
      }
      .modal-content {
        transform: scale(0.9) rotate(-70deg);
        opacity: 0;
        max-width: 45ch;
        padding: 30px;
        border-radius: 20px;
        padding: 2em 2em 4em;
        text-align: center;
        transform: scale(0.8) rotate(-2deg);
        animation: bounceIn 0.75s cubic-bezier(0.68, -0.55, 0.27, 1.55) forwards
          0.25s;
      }
      @keyframes bounceIn {
        0% {
          transform: scale(0.9) rotate(-70deg);
          opacity: 0;
        }
        100% {
          transform: scale(1) rotate(-2deg);
          opacity: 1;
        }
      }

      .modal-content p {
        font-size: 1.3em;
        margin: 0 0 0.5em;
      }
      .modal-content .btn {
        margin-top: 1em;
        font-size: 1.3em;
        transition: background-color 0.25s, transform 0.25s, opacity 0.25s ease;
      }
      address {
        font-style: normal;
        font-size: 13px;
        opacity: 0.5;
      }

      #finalScoreCovers:not(:empty) {
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 1em;
        margin-top: -1em;
        transform: rotate(-2deg);
      }

      #finalScoreCovers:not(:empty) .picked-record {
        box-shadow: 2px 3px 6px #00000030;
        transform: rotate(-4deg);
        background-color: black;
      }

      #finalScoreCovers:not(:empty) .picked-record.bad-cover img {
        opacity: 0.85;
      }

      #finalScoreCovers:not(:empty) .picked-record:only-of-type {
        transform: rotate(2deg);
      }

      #finalScoreCovers:not(:empty) .picked-record:only-of-type img {
        width: calc(var(--crate-size) * 0.7);
      }

      #finalScoreCovers:not(:empty) .picked-record img {
        display: block;
        width: calc(var(--crate-size) * 0.63);
        height: auto;
      }

      #finalScoreCovers:not(:empty) .picked-record:nth-of-type(1) {
        transform: scale(0.9);
      }

      #finalScoreCovers:not(:empty) .picked-record:nth-of-type(2) {
        margin-left: -10%;
        transform: rotate(-2deg);
        top: -2px;
      }

      #finalScoreCovers:not(:empty) .picked-record:nth-of-type(3) {
        margin-left: -10%;
        transform: rotate(1deg) scale(1.05);
        top: -2px;
      }

      #finalScoreCovers:not(:empty) .picked-record:nth-of-type(4) {
        margin-left: -10%;
        transform: rotate(2deg);
        top: 1px;
      }

      #finalScoreCovers:not(:empty) .picked-record:nth-of-type(5) {
        margin-left: -10%;
        transform: scale(0.9) rotate(7deg);
        top: 10px;
      }

      #finalScoreCovers:not(:empty) .good-cover:after {
        content: "üëç";
        position: absolute;
        top: -7px;
        left: -4px;
        font-size: 2em;
        line-height: 1;
        text-shadow: 0 3px 10px #00000090;
        transform: rotate(-15deg);
      }
      #finalScoreCovers:not(:empty) .bad-cover:after {
        content: "üëé";
        position: absolute;
        top: -7px;
        left: -4px;
        font-size: 2em;
        line-height: 1;
        text-shadow: 0 3px 10px #00000090;
        transform: rotate(-12deg);
      }

      footer {
        margin-top: 40px;
      }
    </style>

    <!-- Google tag (gtag.js) -->
    <script
      async
      src="https://www.googletagmanager.com/gtag/js?id=G-113MX2QM7T"
    ></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag() {
        dataLayer.push(arguments);
      }
      gtag("js", new Date());

      gtag("config", "G-113MX2QM7T");
    </script>
  </head>
  <body class="isLoading">
    <div id="background-image" aria-hidden="true">
      <img src="./assets/bg.webp" alt="" />
    </div>
    <div id="loader">Loading the disappointment...</div>
    <div id="startModal" class="modal" role="dialog" style="display: flex">
      <div class="modal-content">
        <h1>It's diggin' time! <span>Beta</span></h1>
        <p>
          The op-shop is just about to close &mdash; you have just 30 seconds to
          look through the crates.
        </p>
        <p>You can only afford 5 records, so choose wisely!</p>

        <button class="btn" id="startButton">Let's go!</button>
      </div>
    </div>
    <div id="giveUpModal" class="modal" role="dialog">
      <div class="modal-content">
        <h2>Giving up already?</h2>
        <p>
          I don't blame you ‚Äî the pickings are pretty woeful! But if you don't
          have a proper look, you might regret it!
        </p>
        <button class="btn" id="anotherGoButton">Give it another go</button>
      </div>
    </div>
    <div id="gameOverModal" class="modal" role="dialog">
      <div class="modal-content">
        <div id="finalScoreTitle"></div>
        <div id="finalScoreCovers"></div>
        <div id="finalScoreMessage"></div>
        <button class="btn" id="restartButton">Want to try again?</button>
      </div>
    </div>
    <main>
      <div class="game-container" id="gameContainer">
        <div class="score-board">
          <div class="score-board--inner">
            <span style="display: none"
              >Good: <span id="goodRecord">0</span></span
            >
            <span style="display: none"
              >Crap: <span id="badRecord">0</span></span
            >
            <span>Total: <span id="total">0</span></span>
            <span>Time left: <span id="timer">30</span>s</span>
          </div>
          <button class="btn" id="cancelGameButton">Give up</button>
        </div>
        <div class="crates-grid">
          <!-- Crates will be dynamically generated here -->
        </div>
      </div>
    </main>

    <footer>
      <address>&copy; J. Ferguson <span id="currentYear"></span></address>
    </footer>

    <script>
      document.addEventListener("DOMContentLoaded", async () => {
        const goodRecordTotal = 11;
        const badRecordTotal = 90;

        /* ---------- Preload ---------- */
        const preloadAssets = async () => {
          const paths = [
            "./assets/bg.webp",
            "./assets/crate-plastic.webp",
            "./assets/crate-plastic--blue.webp",
            "./assets/crate-plastic--green.webp",
            "./assets/crate-plastic--red.webp",
            "./favicon.png",
            ...Array.from(
              { length: goodRecordTotal },
              (_, i) =>
                `./assets/covers-good/cover-good-${String(i + 1).padStart(
                  2,
                  "0"
                )}.webp`
            ),
            ...Array.from(
              { length: badRecordTotal },
              (_, i) =>
                `./assets/covers-bad/cover-bad-${String(i + 1).padStart(
                  2,
                  "0"
                )}.webp`
            ),
          ];
          const preloadImage = (src) =>
            new Promise((res) => {
              const img = new Image();
              img.onload = res;
              img.onerror = res;
              img.src = src;
            });
          await Promise.all([...paths.map(preloadImage), document.fonts.ready]);
        };

        await preloadAssets();
        document.body.classList.remove("isLoading");
        document.body.style.touchAction = "manipulation";

        /* ---------- Shortcuts ---------- */
        const qs = (sel) => document.querySelector(sel);
        const qid = (id) => document.getElementById(id);
        const createEl = (tag, cls) => {
          const el = document.createElement(tag);
          if (cls) el.className = cls;
          return el;
        };

        /* ---------- DOM ---------- */
        const cratesGrid = qs(".crates-grid");
        const startModal = qid("startModal");
        const gameOverModal = qid("gameOverModal");
        const giveUpModal = qid("giveUpModal");
        const finalScoreTitle = qid("finalScoreTitle");
        const finalScoreCovers = qid("finalScoreCovers");
        const finalScoreMessage = qid("finalScoreMessage");

        const goodRecordSpan = qid("goodRecord");
        const badRecordSpan = qid("badRecord");
        const totalSpan = qid("total");
        const timerSpan = qid("timer");
        const yearSpan = qid("currentYear");
        if (yearSpan) yearSpan.textContent = new Date().getFullYear();

        const startButton = qid("startButton");
        const restartButton = qid("restartButton");
        const anotherGoButton = qid("anotherGoButton");
        const cancelGameButton = qid("cancelGameButton");

        /* ---------- State ---------- */
        const RECORD_TYPES = { GOOD: goodRecordTotal, BAD: badRecordTotal };
        const GOOD_CHANCE = 0.1;
        const POP_INTERVAL = 1000;

        let crateElements = [];
        let pickedRecords = [];
        let goodRecord = 0,
          badRecord = 0,
          gameTime = 30;
        let gameActive = false,
          lastPopTime = 0,
          timerId;

        let badCovers = [];

        /* ---------- Crates ---------- */
        function generateCrates() {
          cratesGrid.innerHTML = "";
          crateElements = [];

          for (let i = 0; i < 4; i++) {
            const container = createEl("div", "crate-container");

            const recordBtn = createEl("button", "record");
            recordBtn.dataset.index = i;
            recordBtn.setAttribute("aria-label", "Pick record");

            const recordImg = createEl("img", "record-img");
            recordBtn.appendChild(recordImg);

            const cover = createEl("div", "crate-cover");
            const coverImg = createEl("img", "record-img");
            cover.appendChild(coverImg);

            const box = createEl("div", "crate-box");

            container.append(recordBtn, cover, box);
            cratesGrid.appendChild(container);

            crateElements.push({
              crateEl: container,
              recordEl: recordBtn,
              imgEl: recordImg,
              coverEl: cover,
              coverImgEl: coverImg,
              isLocked: false,
              type: null,
              popTimeout: null,
              popId: null,
            });
          }
        }

        // New shuffle function
        function shuffleArray(array) {
          for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
          }
        }

        function generateBadCovers() {
          badCovers = Array.from(
            { length: badRecordTotal },
            (_, i) =>
              `./assets/covers-bad/cover-bad-${String(i + 1).padStart(
                2,
                "0"
              )}.webp`
          );
          shuffleArray(badCovers);
        }

        function setCrateCovers() {
          // Ensure we have enough covers, even if the number of crates changes
          const coversToUse = badCovers.slice(0, crateElements.length);
          crateElements.forEach((crate, index) => {
            crate.coverImgEl.src = coversToUse[index];
            crate.coverEl.classList.add("bad-record");
          });
        }

        /* ---------- Game Flow ---------- */
        function revealWhenReady(crate, record, hideAfter = POP_INTERVAL) {
          const popId = Symbol();
          crate.popId = popId;
          crate.type = record.type;
          crate.imgEl.src = record.imageUrl;

          const reveal = () => {
            if (!gameActive || crate.popId !== popId) return;
            crate.recordEl.classList.add(`${record.type}-record`, "pop");
            crate.popTimeout = setTimeout(() => hideRecord(crate), hideAfter);
          };

          (crate.imgEl.decode ? crate.imgEl.decode() : Promise.resolve())
            .then(reveal)
            .catch(reveal);
        }

        function popRecord() {
          if (!gameActive) return;

          const spots = crateElements.filter((c) => !c.isLocked);
          if (!spots.length) return;

          const crate = spots[Math.floor(Math.random() * spots.length)];
          crate.isLocked = true;

          const isGood = Math.random() < GOOD_CHANCE;
          const count = RECORD_TYPES[isGood ? "GOOD" : "BAD"];
          const idx = String(Math.floor(Math.random() * count) + 1).padStart(
            2,
            "0"
          );

          revealWhenReady(crate, {
            imageUrl: `./assets/covers-${isGood ? "good" : "bad"}/cover-${
              isGood ? "good" : "bad"
            }-${idx}.webp`,
            type: isGood ? "good" : "bad",
          });
        }

        function hideRecord(crate) {
          crate.recordEl.addEventListener(
            "transitionend",
            (e) => {
              if (e.propertyName !== "transform") return;
              crate.recordEl.classList.remove("good-record", "bad-record");
              crate.isLocked = false;
            },
            { once: true }
          );
          crate.recordEl.classList.remove("pop");
        }

        function updateScoreboard() {
          goodRecordSpan.textContent = goodRecord;
          badRecordSpan.textContent = badRecord;
          totalSpan.textContent = goodRecord + badRecord;
          timerSpan.textContent = gameTime;
        }

        function checkGameOver() {
          if (goodRecord + badRecord >= 5 || gameTime <= 0) {
            gameActive = false;
            showGameOver();
          }
        }

        function showGameOver() {
          clearInterval(timerId);
          finalScoreTitle.innerHTML = "";
          finalScoreMessage.innerHTML = "";
          finalScoreCovers.innerHTML = "";

          if (goodRecord === 0 && badRecord === 0) {
            finalScoreTitle.innerHTML =
              "<h2>Another typical day in the op-shop!</h2>";
            finalScoreMessage.innerHTML =
              "<p>You didn't find a thing worth buying, but at least you didn't waste any money on crap.</p>";
            pickedRecords = [];
          } else if (goodRecord === 0) {
            finalScoreTitle.innerHTML = "<h2>What a waste of money!</h2>";
            finalScoreMessage.innerHTML = "<p>All you bought was crap.</p>";
          } else if (goodRecord === 1 && badRecord === 0) {
            finalScoreTitle.innerHTML = "<h2>So, how'd you go?</h2>";
            finalScoreMessage.innerHTML =
              "<p>You actually found something half-decent for a change, but it has the wrong record inside! Oh well.</p>";
          } else if (goodRecord === 1 && badRecord >= 0) {
            finalScoreTitle.innerHTML = "<h2>So, how'd you go?</h2>";
            finalScoreMessage.innerHTML =
              "<p>You actually found one decent record amongst the crap, but there is a scratch across the best track! Oh well.</p>";
          } else if (goodRecord >= 1) {
            finalScoreTitle.innerHTML = "<h2>Score?</h2>";
            finalScoreMessage.innerHTML = `<p>You found ${goodRecord} good records amongst all that crap - pity they're in terrible condition! What did you expect?!</p>`;
          }

          pickedRecords.forEach((r) => {
            const d = createEl("div", `picked-record ${r.type}-cover`);
            const img = createEl("img");
            img.src = r.imageUrl;
            d.appendChild(img);
            finalScoreCovers.appendChild(d);
          });

          gameOverModal.style.display = "flex";
        }

        function handleRecordClick(crate, e) {
          e?.preventDefault();
          if (!gameActive || !crate.recordEl.classList.contains("pop")) return;

          crate.recordEl.classList.remove("pop");
          clearTimeout(crate.popTimeout);

          pickedRecords.push({ type: crate.type, imageUrl: crate.imgEl.src });
          crate.type === "good" ? goodRecord++ : badRecord++;
          updateScoreboard();
          checkGameOver();
          hideRecord(crate);
        }

        function startGame() {
          startModal.style.display = "none";
          goodRecord = 0;
          badRecord = 0;
          gameTime = 30;
          pickedRecords = [];
          gameActive = true;
          gameOverModal.style.display = "none";
          giveUpModal.style.display = "none";

          crateElements.forEach((c) => {
            c.recordEl.classList.remove("pop", "good-record", "bad-record");
            clearTimeout(c.popTimeout);
            c.isLocked = false;
            c.popId = null;
          });

          updateScoreboard();
          clearInterval(timerId);
          timerId = setInterval(() => {
            gameTime--;
            updateScoreboard();
            checkGameOver();
          }, 1000);

          lastPopTime = performance.now();
          requestAnimationFrame(gameLoop);
        }

        function cancelGame() {
          gameActive = false;
          clearInterval(timerId);
          pickedRecords = [];
          giveUpModal.style.display = "flex";
          crateElements.forEach((c) => {
            clearTimeout(c.popTimeout);
            c.recordEl.classList.remove("pop");
            c.isLocked = false;
            c.popId = null;
          });
        }

        function gameLoop(ts) {
          if (gameActive && ts - lastPopTime > POP_INTERVAL) {
            popRecord();
            lastPopTime = ts;
          }
          requestAnimationFrame(gameLoop);
        }

        /* ---------- Listeners ---------- */
        [startButton, restartButton, anotherGoButton].forEach((btn) =>
          btn.addEventListener("click", startGame)
        );
        cancelGameButton.addEventListener("click", cancelGame);

        generateCrates();
        generateBadCovers();
        setCrateCovers();

        crateElements.forEach((c) => {
          c.recordEl.addEventListener(
            "pointerdown",
            (e) => handleRecordClick(c, e),
            { passive: false }
          );
          c.recordEl.addEventListener("keydown", (e) => {
            if (e.key === "Enter" || e.key === " ") handleRecordClick(c, e);
          });
        });

        gameLoop(0);
      });
    </script>
  </body>
</html>
