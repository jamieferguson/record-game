<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Diggin' time! (BETA)</title>
    <meta
      name="description"
      content="A realistic op-shop record hunting simulator (of sorts). Prepare to be disappointed!"
    />
    <meta
      name="theme-color"
      content="#eae9e0"
      media="(prefers-color-scheme: light)"
    />
    <meta
      name="theme-color"
      content="#eae9e0;"
      media="(prefers-color-scheme: dark)"
    />

    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Bagel+Fat+One&family=Inter:ital,opsz,wght@0,14..32,100..900;1,14..32,100..900&display=swap"
      rel="stylesheet"
    />
    <link rel="shortcut icon" href="./favicon.png" />

    <style>
      :root {
        --bg-color: #eae9e0;
        --text-color: #333;
        --text-color--modal: var(--text-color);
        --text-color--button: var(--text-color);

        --shelf-color: #fdf8f1;
        --shelf-height: 15px;
        --wall-color: var(--bg-color);

        --highlight-color-good: var(--text-color);
        --highlight-color-bad: var(--text-color);

        --title-color: #ffdf8f;

        --bodyFont: "Inter", sans-serif;
        --titleFont: "Bagel Fat One", "Inter", sans-serif;

        --crate-size: 145px;
        @media (width> 500px) {
          --crate-size: 200px;
        }
        @media (width> 1000px) {
          --crate-size: 220px;
        }
        @media (height> 1000px) {
          --crate-size: 250px;
        }
        @media (height> 1200px) {
          --crate-size: 300px;
        }
      }
      html * {
        box-sizing: border-box;
        position: relative;
      }
      body {
        background-color: var(--bg-color);
        color: var(--text-color);
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        margin: 0;
        padding: 20px 10px 50px;
        box-sizing: border-box;
        user-select: none;
        -webkit-user-select: none;
        touch-action: none;
        font-family: var(--bodyFont);
        font-size: 14px;
        min-height: 100vh;
        @media (width>500px) {
          font-size: 16px;
        }
        @media (width> 1000px) {
          font-size: 18px;
        }
        @media (width> 1200px) {
          font-size: 20px;
        }
      }

      .loading {
        opacity: 0;
      }

      main {
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        transition: opacity 0.5s ease;
      }

      h1,
      h2,
      h3 {
        font-family: var(--titleFont);
        line-height: 0.73;
        letter-spacing: -0.02em;
        margin: 0 auto 0.45em;
        text-shadow: 0 4px 4px #00000010, 0 10px 20px #00000020,
          0 20px 50px #00000030;
        color: var(--title-color);
        transform: rotate(-3deg);
      }

      h1 {
        text-align: center;
        font-size: calc(5.5em + 4vmin);
      }

      h1 span {
        display: inline-flex;
        font-family: var(--bodyFont);
        font-size: 13px;
        letter-spacing: normal;
        position: absolute;
        bottom: -1.3em;
        left: 70%;
        transform: translateX(-50%) rotate(2deg);
        z-index: 1;
        line-height: 1;
        color: var(--text-color);
        text-shadow: none;
        background-color: white;
        padding: 0.35em 0.75em;
        border-radius: 5em;
        border: 1px solid #00000030;
        box-shadow: 0 2px 15px #00000030;
        text-transform: uppercase;
      }

      h2 {
        font-size: calc(4.5em + 1vmin);
        max-width: 7ch;
      }

      p {
        line-height: 1.5;
      }

      .btn {
        font-size: 1em;
        padding: 0.5em 1em;
        background: #ffffffcc;
        backdrop-filter: blur(20px);
        color: var(--text-color--button);
        font-weight: 600;
        border: none;
        border-radius: 5em;
        cursor: pointer;
        transition: background-color 0.25s, transform 0.25s;
        box-shadow: 0 2px 10px #00000020, 0 10px 20px #00000010,
          0 5px 10px #00000010, inset 0 2px 3px #ffffff90;
      }

      .btn:hover,
      .btn:focus-visible {
        background-color: white;
        transform: scale(1.05);
      }

      /* LOADER */

      #loader {
        display: none;
        position: fixed;
        top: 50%;
        left: 50%;
        pointer-events: none;
        opacity: 0;
        transition: opacity 0.5s ease, transform 0.5s ease;
        transform: translate(-50%, -50%) scale(0.2);
        text-align: center;
        flex-direction: column;
        gap: 0.5em;
        align-items: center;
        width: 80%;
        max-width: 400px;
      }

      #loader label {
        font-size: 0.8em;
        font-weight: 600;
      }

      #loader progress {
        width: 100%;
        height: 20px;
        border-radius: 50px;
      }

      #loader progress::-webkit-progress-bar {
        background-color: #00000020;
        border-radius: 50px;
        padding: 2px;
        overflow: hidden;
      }

      #loader progress::-webkit-progress-value {
        background-color: white;
        border-radius: 50px;
      }

      .isLoading #loader {
        display: inline-flex;
        opacity: 0.5;
        transform: translate(-50%, -50%);
        z-index: 1001;
        margin-inline: auto;
        font-size: 1.2em;
        font-weight: 600;
      }

      .isLoading .modal {
        display: none !important;
      }

      .isLoading main,
      .isLoading #background-image,
      .isLoading footer {
        opacity: 0;
      }

      /* GAME */
      #gameContainer {
        display: flex;
        gap: 10px;
        /* background-color: var(--wall-color); */
        border-radius: 20px;
        flex-direction: column;
        align-items: center;
        padding: 10px 10px 20px;
        gap: 0;
        box-shadow: 0 30px 100px #00000020;
        backdrop-filter: blur(10px);

        @media (width>500px) {
          padding: 20px;
        }
        @media (width>800px) {
          padding: 30px;
        }
      }

      /* SCORE */
      #scoreBoard {
        position: sticky;
        z-index: 120;
        top: 20px;
        display: flex;
        gap: 10px;
        justify-content: space-between;
        align-items: center;
        width: 100%;
        font-size: 0.8em;
        text-align: center;
      }
      #scoreBoard--inner {
        display: flex;
        gap: 2px;
        border-radius: 5px;
        overflow: hidden;
      }

      #scoreBoard--inner > span {
        background-color: #ffffff60;
        backdrop-filter: blur(20px);
        padding: 0.5em 0.75em;
        font-weight: 600;
      }

      /* CRATES */
      #cratesContainer {
        overflow: hidden;
      }

      .cratesRow {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 0 6px;
        touch-action: none;
        padding-inline: 15px;
        padding-bottom: 2px;
        overflow: visible;
        bottom: -3px;
        @media (width>500px) {
          padding-inline: 25px;
        }
      }

      /* CRATE SHADOW */

      .cratesRow:after {
        pointer-events: none;
        content: "";
        position: absolute;
        bottom: 0;
        left: 25%;
        right: 25%;
        height: 50%;
        z-index: -1;
        filter: blur(10px);
        background: linear-gradient(
          180deg,
          rgba(0, 0, 0, 0) 0%,
          rgba(0, 0, 0, 0.5) 100%
        );
      }

      #cratesRow-01:before {
        pointer-events: none;
        content: "";
        position: absolute;
        top: 50%;
        left: 12px;
        right: 12px;
        height: 80%;
        z-index: -1;
        background: linear-gradient(
          180deg,
          rgba(0, 0, 0, 0) 0%,
          rgba(0, 0, 0, 0.3) 63%,
          rgba(0, 0, 0, 0.2) 64%,
          rgba(0, 0, 0, 0) 100%
        );
        filter: blur(7px);
      }

      #cratesRow-02:before {
        pointer-events: none;
        content: "";
        position: absolute;
        top: 20%;
        left: 12px;
        right: 12px;
        height: 100%;
        z-index: -1;
        background: linear-gradient(
          180deg,
          rgba(0, 0, 0, 0) 0%,
          rgba(0, 0, 0, 0.3) 100%
        );
        filter: blur(7px);
      }

      .crateContainer {
        position: relative;
      }

      .crateContainer--inner {
        position: relative;
        width: var(--crate-size);
        height: calc(var(--crate-size) * 1.7);
      }

      .crate-box {
        position: absolute;
        width: 100%;
        aspect-ratio: 1;
        background: url(./assets/crate-plastic--orange.webp) no-repeat bottom
          left;
        background-size: 100% 85%;
        bottom: 0;
        left: 0;
        z-index: 10;
        pointer-events: none;
        cursor: default;
      }

      #crate-01 .crate-box {
        background-image: url(./assets/crate-plastic--orange.webp);
      }

      #crate-02 .crate-box {
        background-image: url(./assets/crate-plastic--blue.webp);
      }

      #crate-03 .crate-box {
        background-image: url(./assets/crate-plastic--green.webp);
      }

      #crate-04 .crate-box {
        background-image: url(./assets/crate-plastic--red.webp);
      }

      .crate-cover {
        position: absolute;
        bottom: 0;
        left: 3%;
        width: 94%;
        aspect-ratio: 1;
        z-index: 5;
        transform: translateY(0);
        border-radius: 2px;
        background-color: black;
        box-shadow: 0 -1px 1px #00000030;
        cursor: default;
      }

      .crate-cover img {
        opacity: 0.85;
      }

      .crate-cover:before {
        content: "";
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        top: 20%;
        z-index: 1;
        background-color: #00000070;
      }

      /* RECORDS */

      .record {
        will-change: transform;
        border: none;
        background-color: transparent;
        padding: 0;
        border-radius: 3px;
        overflow: hidden;
        position: absolute;
        top: 4%;
        left: 4%;
        width: 92%;
        aspect-ratio: 1;
        cursor: pointer;
        transition: transform 0.15s cubic-bezier(0.71, -0.36, 0.35, 1.37);
        transform: translateY(76%);
        z-index: 1;
        -webkit-tap-highlight-color: transparent;
      }
      .record:after {
        content: "";
        position: absolute;
        pointer-events: none;
        bottom: 0;
        left: 0;
        right: 0;
        height: 55%;
        background: linear-gradient(
          180deg,
          rgba(0, 0, 0, 0) 0%,
          rgba(0, 0, 0, 0.5) 40%,
          rgba(0, 0, 0, 0.5) 100%
        );
      }
      .record:active {
        opacity: 0.9;
      }

      .record.pop {
        pointer-events: auto;
        transform: translateY(0);
        transition: transform 0.25s cubic-bezier(0.71, -0.36, 0.35, 1.37);
      }

      .crateContainer:nth-of-type(odd) .record.pop {
        transform: translateY(5%) rotate(1deg);
      }

      .crateContainer:nth-of-type(even) .record.pop {
        transform: translateY(5%) rotate(-1deg);
      }

      .record-img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }

      /* SHELVES */
      .shelf {
        height: var(--shelf-height);
        background-color: var(--shelf-color);
        border-top: 1px solid #ffffff90;
        border-bottom: 1px solid #00000060;
        z-index: 200;
        border-radius: 3px;
      }

      .shelfDecoration {
        position: absolute;
        z-index: 100;
      }

      /* SIGN */
      #decoration--sign {
        color: #000000aa;
        position: absolute;
        background-color: #e6dda6dd;
        background: linear-gradient(349deg, #f0efe3 0%, #e6dda6dd 100%);
        box-shadow: 2px 3px 2px #00000060;
        padding: 1em;
        font-weight: 600;
        left: 50%;
        transform: translateX(-50%) rotate(-4deg);
        top: 63%;
        border-radius: 3px;
        font-size: clamp(11px, 2vw, 18px);
        text-align: center;
        width: 11ch;
      }

      /* TAPE */
      #decoration--tape {
        width: 4%;
        height: 5%;
        background-color: #f0efe380;
        position: absolute;
        left: 50%;
        transform: translateX(-50%) rotate(-2deg);
        top: 60%;
        box-shadow: 0 1px 2px #00000030;
        z-index: 101;
      }

      /* #decoration--sign.fall {
        animation: signFall 0.5s ease-in forwards 0.5s;
        box-shadow: none;
      }

      @keyframes signFall {
        0% {
          transform: translateY(0) translateX(-50%) rotate(-2deg);
          opacity: 0.9;
          filter: blur(1px);
        }
        100% {
          transform: translateY(900px) translateX(-50%) rotate(60deg);
          opacity: 0.9;
          filter: blur(1px);
        }
      } */

      #decoration--car {
        width: 35%;
        left: 16%;
        bottom: 0;
      }

      #decoration--car.roll {
        animation: carRoll 0.5s ease-in-out forwards;
        filter: blur(1px);
      }

      @keyframes carRoll {
        0% {
          transform: translateX(0);
        }
        10% {
          transform: translateX(-5%);
        }
        99% {
          transform: translateX(700px);
        }
        100% {
          transform: translateX(700px);
          display: none;
        }
      }

      /* MODALS */

      #modalContainer {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        background-color: #e1dfd190;
        backdrop-filter: blur(20px);
        pointer-events: none;
        transition: opacity 0.5s ease;
        z-index: -1;
        opacity: 0;
      }

      #modalContainer.visible {
        z-index: 1000;
        opacity: 1;
      }

      .modal {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        color: var(--text-color--modal);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 1001;
      }
      .modalContent {
        transform: scale(0.9) rotate(-70deg);
        opacity: 0;
        max-width: 45ch;
        padding: 30px;
        border-radius: 20px;
        padding: 2em 2em 3em;
        text-align: center;
        transform: scale(0.8) rotate(-2deg);
        animation: bounceIn 0.75s cubic-bezier(0.68, -0.55, 0.27, 1.55) forwards
          0.5s;
        pointer-events: all;
      }
      @keyframes bounceIn {
        0% {
          pointer-events: none;
          transform: scale(0.9) rotate(-70deg);
          opacity: 0;
        }
        99% {
          transform: scale(1) rotate(-2deg);
          opacity: 1;
          pointer-events: none;
        }
        100% {
          transform: scale(1) rotate(-2deg);
          opacity: 1;
          pointer-events: all;
        }
      }

      .modalContent p {
        font-size: 1.3em;
        margin: 0 0 0.5em;
      }
      .modalContent .btn {
        margin-top: 1em;
        font-size: 1.3em;
        transition: background-color 0.25s, transform 0.25s, opacity 0.25s ease;
      }

      #finalScoreCovers:not(:empty) {
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 1em;
        margin-top: -1em;
        transform: rotate(-2deg);
      }

      #finalScoreCovers:not(:empty) .picked-record {
        box-shadow: 2px 3px 6px #00000030;
        transform: rotate(-4deg);
        background-color: black;
      }

      #finalScoreCovers:not(:empty) .picked-record.bad-cover img {
        opacity: 0.85;
      }

      #finalScoreCovers:not(:empty) .picked-record:only-of-type {
        transform: rotate(2deg);
      }

      #finalScoreCovers:not(:empty) .picked-record:only-of-type img {
        width: calc(var(--crate-size) * 0.7);
      }

      #finalScoreCovers:not(:empty) .picked-record img {
        display: block;
        width: calc(var(--crate-size) * 0.63);
        height: auto;
      }

      #finalScoreCovers:not(:empty) .picked-record:nth-of-type(1) {
        transform: scale(0.9);
      }

      #finalScoreCovers:not(:empty) .picked-record:nth-of-type(2) {
        margin-left: -10%;
        transform: rotate(-2deg);
        top: -2px;
      }

      #finalScoreCovers:not(:empty) .picked-record:nth-of-type(3) {
        margin-left: -10%;
        transform: rotate(1deg) scale(1.05);
        top: -2px;
      }

      #finalScoreCovers:not(:empty) .picked-record:nth-of-type(4) {
        margin-left: -10%;
        transform: rotate(2deg);
        top: 1px;
      }

      #finalScoreCovers:not(:empty) .picked-record:nth-of-type(5) {
        margin-left: -10%;
        transform: scale(0.9) rotate(7deg);
        top: 10px;
      }

      #finalScoreCovers:not(:empty) .good-cover:after {
        content: "👍";
        position: absolute;
        top: -7px;
        left: -4px;
        font-size: 2em;
        line-height: 1;
        text-shadow: 0 3px 10px #00000090;
        transform: rotate(-15deg);
      }
      #finalScoreCovers:not(:empty) .bad-cover:after {
        content: "👎";
        position: absolute;
        top: -7px;
        left: -4px;
        font-size: 2em;
        line-height: 1;
        text-shadow: 0 3px 10px #00000090;
        transform: rotate(-12deg);
      }

      /* FOOTER */

      footer {
        margin-top: 25px;
      }

      address {
        font-style: normal;
        font-size: 13px;
        opacity: 0.5;
      }
    </style>

    <!-- Google tag (gtag.js) -->
    <script
      async
      src="https://www.googletagmanager.com/gtag/js?id=G-113MX2QM7T"
    ></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag() {
        dataLayer.push(arguments);
      }
      gtag("js", new Date());

      gtag("config", "G-113MX2QM7T");
    </script>
  </head>
  <body class="isLoading">
    <div id="loader" role="status">
      <progress id="progress-bar" value="0" max="100"></progress>
      <label for="progress-bar">Preparing the disappointment...</label>
    </div>

    <main id="gameContainer">
      <div id="scoreBoard">
        <div id="scoreBoard--inner" role="status" aria-live="polite">
          <span>Total: <span id="total">0</span></span>
          <span>Time left: <span id="timer">30</span>s</span>
        </div>
        <button class="btn" id="cancelGameButton">I give up</button>
      </div>

      <div id="cratesContainer">
        <div id="cratesRow-01" class="cratesRow">
          <div id="crate-01" class="crateContainer">
            <div class="crateContainer--inner"></div>
          </div>
          <div id="crate-02" class="crateContainer">
            <div class="crateContainer--inner"></div>
            <div
              id="decoration--sign"
              class="shelfDecoration"
              aria-hidden="true"
            >
              records: $2 each
            </div>
            <div
              class="shelfDecoration"
              id="decoration--tape"
              aria-hidden="true"
            ></div>
          </div>
        </div>
        <div class="shelf"></div>
        <div id="cratesRow-02" class="cratesRow">
          <div id="crate-03" class="crateContainer">
            <div class="crateContainer--inner"></div>
            <img
              id="decoration--car"
              class="shelfDecoration"
              src="./assets/decoration--car.webp"
              alt=""
            />
          </div>
          <div id="crate-04" class="crateContainer">
            <div class="crateContainer--inner"></div>
          </div>
        </div>
        <div class="shelf"></div>
      </div>
    </main>

    <footer>
      <address>&copy; J. Ferguson <span id="currentYear"></span></address>
    </footer>

    <div id="modalContainer" class="visible">
      <div id="startModal" class="modal" style="display: flex">
        <div class="modalContent" role="status" aria-live="polite">
          <h1>It's diggin' time! <span>Beta</span></h1>
          <p>
            The local op-shop is just about to close &mdash; you have just 30
            seconds to look through the crates.
          </p>
          <p>You can only afford 5 records, so choose wisely!</p>

          <button class="btn" id="startButton">Let's go!</button>
        </div>
      </div>

      <div id="giveUpModal" class="modal">
        <div class="modalContent" role="status" aria-live="polite">
          <h2>Giving up already?</h2>
          <p>
            I don't blame you — the pickings are pretty woeful! But if you don't
            have a proper look, you might regret it!
          </p>
          <button class="btn" id="anotherGoButton">Give it another go</button>
        </div>
      </div>

      <div id="gameOverModal" class="modal">
        <div class="modalContent" role="status" aria-live="polite">
          <div id="finalScoreTitle"></div>
          <div id="finalScoreCovers"></div>
          <div id="finalScoreMessage"></div>
          <button class="btn" id="restartButton">Want to try again?</button>
        </div>
      </div>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", async () => {
        const goodRecordTotal = 11;
        const badRecordTotal = 100;

        /* ---------- Preload ---------- */
        const preloadAssets = async () => {
          const paths = [
            "./assets/decoration--car.webp",
            "./assets/crate-plastic--orange.webp",
            "./assets/crate-plastic--blue.webp",
            "./assets/crate-plastic--green.webp",
            "./assets/crate-plastic--red.webp",
            "./favicon.png",
            ...Array.from(
              { length: goodRecordTotal },
              (_, i) =>
                `./assets/covers-good/cover-good-${String(i + 1).padStart(
                  2,
                  "0"
                )}.webp`
            ),
            ...Array.from(
              { length: badRecordTotal },
              (_, i) =>
                `./assets/covers-bad/cover-bad-${String(i + 1).padStart(
                  2,
                  "0"
                )}.webp`
            ),
          ];
          const preloadImage = (src) =>
            new Promise((res) => {
              const img = new Image();
              img.onload = res;
              img.onerror = res;
              img.src = src;
            });
          await Promise.all([...paths.map(preloadImage), document.fonts.ready]);
        };

        await preloadAssets();
        const progressBar = document.getElementById("progress-bar");

        function updateProgress(value) {
          progressBar.value = value;
        }

        let currentProgress = 0;
        const interval = setInterval(() => {
          if (currentProgress < 100) {
            currentProgress += 10;
            updateProgress(currentProgress);
          } else {
            clearInterval(interval);
            document.body.classList.remove("isLoading");
          }
        }, 500);
        document.body.style.touchAction = "manipulation";

        /* ---------- Shortcuts ---------- */
        const qs = (sel) => document.querySelector(sel);
        const qid = (id) => document.getElementById(id);
        const createEl = (tag, cls) => {
          const el = document.createElement(tag);
          if (cls) el.className = cls;
          return el;
        };

        /* ---------- DOM ---------- */

        const crateContainer = qs(".crateContainer");
        const crateContainerInner = document.querySelectorAll(
          ".crateContainer--inner"
        );
        const modalContainer = qid("modalContainer");
        const startModal = qid("startModal");
        const gameOverModal = qid("gameOverModal");
        const giveUpModal = qid("giveUpModal");
        const finalScoreTitle = qid("finalScoreTitle");
        const finalScoreCovers = qid("finalScoreCovers");
        const finalScoreMessage = qid("finalScoreMessage");

        const totalSpan = qid("total");
        const timerSpan = qid("timer");
        const yearSpan = qid("currentYear");
        if (yearSpan) yearSpan.textContent = new Date().getFullYear();

        const startButton = qid("startButton");
        const restartButton = qid("restartButton");
        const anotherGoButton = qid("anotherGoButton");
        const cancelGameButton = qid("cancelGameButton");

        const decorationCar = qid("decoration--car");
        // const decorationSign = qid("decoration--sign");

        /* ---------- State ---------- */
        const RECORD_TYPES = { GOOD: goodRecordTotal, BAD: badRecordTotal };
        const GOOD_CHANCE = 0.1;
        const POP_INTERVAL = 1000;

        let crateElements = [];
        let pickedRecords = [];
        let goodRecord = 0,
          badRecord = 0,
          gameTime = 30;
        let gameActive = false,
          lastPopTime = 0,
          timerId;

        let badCovers = [];
        let availableBadCovers = []; // New state variable

        /* ---------- Crates ---------- */
        function generateCrates() {
          // Select all existing .crateContainer elements

          crateElements = [];

          // Iterate over each container element
          crateContainerInner.forEach((container, i) => {
            // Clear any existing content in the container
            container.innerHTML = "";

            const recordBtn = document.createElement("button");
            recordBtn.className = "record";
            recordBtn.dataset.index = i;
            recordBtn.setAttribute("aria-label", "Pick record");

            const recordImg = document.createElement("img");
            recordImg.className = "record-img";
            recordBtn.appendChild(recordImg);

            const cover = document.createElement("div");
            cover.className = "crate-cover";
            const coverImg = document.createElement("img");
            coverImg.className = "record-img";
            cover.appendChild(coverImg);

            const box = document.createElement("div");
            box.className = "crate-box";

            // Append the newly created elements to the existing container
            container.append(recordBtn, cover, box);

            // Push the new object to the crateElements array
            crateElements.push({
              crateEl: container,
              recordEl: recordBtn,
              imgEl: recordImg,
              coverEl: cover,
              coverImgEl: coverImg,
              isLocked: false,
              type: null,
              popTimeout: null,
              popId: null,
            });
          });
        }

        // New shuffle function
        function shuffleArray(array) {
          for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
          }
        }

        function generateBadCovers() {
          badCovers = Array.from(
            { length: badRecordTotal },
            (_, i) =>
              `./assets/covers-bad/cover-bad-${String(i + 1).padStart(
                2,
                "0"
              )}.webp`
          );
          shuffleArray(badCovers);
        }

        function setCrateCovers() {
          const coversToUse = badCovers.slice(0, crateElements.length);
          crateElements.forEach((crate, index) => {
            crate.coverImgEl.src = coversToUse[index];
            crate.coverEl.classList.add("bad-record");
          });
        }

        /* ---------- Game Flow ---------- */
        function revealWhenReady(crate, record, hideAfter = POP_INTERVAL) {
          const popId = Symbol();
          crate.popId = popId;
          crate.type = record.type;
          crate.imgEl.src = record.imageUrl;

          const reveal = () => {
            if (!gameActive || crate.popId !== popId) return;
            crate.recordEl.classList.add(`${record.type}-record`, "pop");
            crate.popTimeout = setTimeout(() => hideRecord(crate), hideAfter);
          };

          (crate.imgEl.decode ? crate.imgEl.decode() : Promise.resolve())
            .then(reveal)
            .catch(reveal);
        }

        function popRecord() {
          if (!gameActive) return;

          const spots = crateElements.filter((c) => !c.isLocked);
          if (!spots.length) return;

          const crate = spots[Math.floor(Math.random() * spots.length)];
          crate.isLocked = true;

          const isGood = Math.random() < GOOD_CHANCE;
          let imageUrl, type;

          if (isGood) {
            const count = RECORD_TYPES.GOOD;
            const idx = String(Math.floor(Math.random() * count) + 1).padStart(
              2,
              "0"
            );
            imageUrl = `./assets/covers-good/cover-good-${idx}.webp`;
            type = "good";
          } else {
            // Select a unique bad cover
            const idx = Math.floor(Math.random() * availableBadCovers.length);
            imageUrl = availableBadCovers.splice(idx, 1)[0]; // Remove from the pool
            type = "bad";
          }

          revealWhenReady(crate, {
            imageUrl: imageUrl,
            type: type,
          });
        }

        function hideRecord(crate) {
          crate.recordEl.addEventListener(
            "transitionend",
            (e) => {
              if (e.propertyName !== "transform") return;
              crate.recordEl.classList.remove("good-record", "bad-record");
              crate.isLocked = false;
            },
            { once: true }
          );
          crate.recordEl.classList.remove("pop");
        }

        function updateScoreboard() {
          totalSpan.textContent = goodRecord + badRecord;
          timerSpan.textContent = gameTime;
        }

        function checkGameOver() {
          if (goodRecord + badRecord >= 5 || gameTime <= 0) {
            gameActive = false;

            showGameOver();
          }
        }

        // DECORATIONS
        function addAnimationOnInteraction(el, animationClass) {
          if (!el) return;

          // Desktop hover
          el.addEventListener("mouseenter", () => {
            el.classList.add(animationClass);
          });

          // Touch (mobile / tablet)
          el.addEventListener("touchstart", () => {
            el.classList.add(animationClass);
          });
        }

        addAnimationOnInteraction(decorationCar, "roll");
        // addAnimationOnInteraction(decorationSign, "fall");

        function showGameOver() {
          clearInterval(timerId);
          finalScoreTitle.innerHTML = "";
          finalScoreMessage.innerHTML = "";
          finalScoreCovers.innerHTML = "";

          if (goodRecord === 0 && badRecord === 0) {
            finalScoreTitle.innerHTML =
              "<h2>Another typical day in the op-shop!</h2>";
            finalScoreMessage.innerHTML =
              "<p>You didn't find a thing worth buying, but at least you didn't waste any money.</p>";
            pickedRecords = [];
          } else if (goodRecord === 0) {
            finalScoreTitle.innerHTML = "<h2>What a waste of money!</h2>";
            finalScoreMessage.innerHTML = "<p>All you bought was crap.</p>";
          } else if (goodRecord === 1 && badRecord === 0) {
            finalScoreTitle.innerHTML = "<h2>How'd you go?</h2>";
            finalScoreMessage.innerHTML =
              "<p>You actually found something half-decent for a change, but it has the wrong record inside! Oh well.</p>";
          } else if (goodRecord === 1 && badRecord >= 0) {
            finalScoreTitle.innerHTML = "<h2>How'd you go?</h2>";
            finalScoreMessage.innerHTML =
              "<p>You actually found one decent record amongst the crap, but there is a scratch across the best track! Oh well.</p>";
          } else if (goodRecord >= 1) {
            finalScoreTitle.innerHTML = "<h2>Any luck?</h2>";
            finalScoreMessage.innerHTML = `<p>You found ${goodRecord} good records amongst all that crap - pity they're in unplayable condition! What did you expect?!</p>`;
          }

          pickedRecords.forEach((r) => {
            const d = createEl("div", `picked-record ${r.type}-cover`);
            const img = createEl("img");
            img.src = r.imageUrl;
            d.appendChild(img);
            finalScoreCovers.appendChild(d);
          });
          modalContainer.classList.add("visible");
          gameOverModal.style.display = "flex";
        }

        function handleRecordClick(crate, e) {
          e?.preventDefault();
          if (!gameActive || !crate.recordEl.classList.contains("pop")) return;

          crate.recordEl.classList.remove("pop");
          clearTimeout(crate.popTimeout);

          pickedRecords.push({ type: crate.type, imageUrl: crate.imgEl.src });
          crate.type === "good" ? goodRecord++ : badRecord++;
          updateScoreboard();
          checkGameOver();
          hideRecord(crate);
        }

        function startGame() {
          // NEW: Reset the pool of available bad covers at the start of each game.
          availableBadCovers = [...badCovers]; // Create a shallow copy
          goodRecord = 0;
          badRecord = 0;
          gameTime = 30;
          pickedRecords = [];
          gameActive = true;
          startModal.style.display = "none";
          modalContainer.classList.remove("visible");
          gameOverModal.style.display = "none";
          giveUpModal.style.display = "none";

          crateElements.forEach((c) => {
            c.recordEl.classList.remove("pop", "good-record", "bad-record");
            clearTimeout(c.popTimeout);
            c.isLocked = false;
            c.popId = null;
          });

          updateScoreboard();
          clearInterval(timerId);
          timerId = setInterval(() => {
            gameTime--;
            updateScoreboard();
            checkGameOver();
          }, 1000);

          lastPopTime = performance.now();
          requestAnimationFrame(gameLoop);
        }

        function cancelGame() {
          gameActive = false;
          clearInterval(timerId);
          pickedRecords = [];
          modalContainer.classList.add("visible");
          giveUpModal.style.display = "flex";
          crateElements.forEach((c) => {
            clearTimeout(c.popTimeout);
            c.recordEl.classList.remove("pop");
            c.isLocked = false;
            c.popId = null;
          });
        }

        function gameLoop(ts) {
          if (gameActive && ts - lastPopTime > POP_INTERVAL) {
            popRecord();
            lastPopTime = ts;
          }
          requestAnimationFrame(gameLoop);
        }

        const handleStartClick = () => {
          // console.log("GA Event Fired:", "game_start", {
          //   event_category: "Game Flow",
          //   event_label: "Start Button Click",
          // });
          gtag("event", "game_start", {
            event_category: "Game Flow",
            event_label: "Start Button Click",
          });
          startGame();
        };

        const handleRestartClick = () => {
          // console.log("GA Event Fired:", "game_restart", {
          //   event_category: "Game Flow",
          //   event_label: "Restart Button Click",
          // });
          gtag("event", "game_restart", {
            event_category: "Game Flow",
            event_label: "Restart Button Click",
          });
          startGame();
        };

        const handleAnotherGoClick = () => {
          // console.log("GA Event Fired:", "game_continue", {
          //   event_category: "Game Flow",
          //   event_label: "Another Go Button Click",
          // });
          gtag("event", "game_continue", {
            event_category: "Game Flow",
            event_label: "Another Go Button Click",
          });
          startGame();
        };

        const handleCancelClick = () => {
          // console.log("GA Event Fired:", "game_give_up", {
          //   event_category: "Game Flow",
          //   event_label: "Give Up Button Click",
          // });
          gtag("event", "game_give_up", {
            event_category: "Game Flow",
            event_label: "Give Up Button Click",
          });
          cancelGame();
        };

        /* ---------- Listeners ---------- */
        startButton.addEventListener("click", handleStartClick);
        restartButton.addEventListener("click", handleRestartClick);
        anotherGoButton.addEventListener("click", handleAnotherGoClick);
        cancelGameButton.addEventListener("click", handleCancelClick);

        generateCrates();
        generateBadCovers();
        setCrateCovers();

        crateElements.forEach((c) => {
          c.recordEl.addEventListener(
            "pointerdown",
            (e) => handleRecordClick(c, e),
            { passive: false }
          );
          c.recordEl.addEventListener("keydown", (e) => {
            if (e.key === "Enter" || e.key === " ") handleRecordClick(c, e);
          });
        });

        gameLoop(0);
      });
    </script>
  </body>
</html>
